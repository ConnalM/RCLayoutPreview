<UserControl x:Class="RCLayoutPreview.Controls.SnippetGallery"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:RCLayoutPreview.Controls"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="300">
    <UserControl.Resources>
        <DataTemplate x:Key="SnippetPreviewTemplate">
            <Border BorderBrush="#FFCCCCCC" BorderThickness="1" Background="#FFF9F9F9" Padding="4" Margin="0,0,0,4">
                <ContentPresenter>
                    <ContentPresenter.Content>
                        <MultiBinding Converter="{x:Null}">
                            <Binding Path="XamlTemplate" FallbackValue="[Preview not available]"/>
                        </MultiBinding>
                    </ContentPresenter.Content>
                </ContentPresenter>
            </Border>
        </DataTemplate>
        <DataTemplate x:Key="SafeSnippetPreviewTemplate">
            <Border BorderBrush="#FFCCCCCC" BorderThickness="1" Background="#FFF9F9F9" Padding="4" Margin="0,0,0,4">
                <TextBlock Text="{Binding XamlTemplate, FallbackValue='[Preview not available]'}" 
                          FontFamily="Consolas" FontSize="10" TextWrapping="Wrap" 
                          MaxHeight="100" TextTrimming="CharacterEllipsis"/>
            </Border>
        </DataTemplate>
    </UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Grid>
            <TextBox x:Name="SearchBox" 
                     Margin="5"
                     Padding="5,3"
                     TextChanged="SearchBox_TextChanged"/>
            <TextBlock Text="Search snippets..."
                      Margin="10,7,0,0"
                      Foreground="Gray"
                      IsHitTestVisible="False">
                <TextBlock.Style>
                    <Style TargetType="TextBlock">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Text, ElementName=SearchBox}" Value="">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Text, ElementName=SearchBox}" Value="{x:Null}">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding Text, ElementName=SearchBox}" Value=""/>
                                    <Condition Binding="{Binding IsFocused, ElementName=SearchBox}" Value="True"/>
                                </MultiDataTrigger.Conditions>
                                <Setter Property="Visibility" Value="Hidden"/>
                            </MultiDataTrigger>
                        </Style.Triggers>
                        <Setter Property="Visibility" Value="Hidden"/>
                    </Style>
                </TextBlock.Style>
            </TextBlock>
        </Grid>

        <ScrollViewer Grid.Row="1" 
                     VerticalScrollBarVisibility="Auto" 
                     HorizontalScrollBarVisibility="Disabled">
            <ItemsControl x:Name="SnippetsList">
                <ItemsControl.GroupStyle>
                    <GroupStyle>
                        <GroupStyle.HeaderTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Name}" 
                                         FontWeight="Bold" 
                                         Margin="5,10,5,5"/>
                            </DataTemplate>
                        </GroupStyle.HeaderTemplate>
                    </GroupStyle>
                </ItemsControl.GroupStyle>
                
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border x:Name="SnippetItem" 
                                Margin="5,2"
                                Padding="8"
                                BorderThickness="1"
                                BorderBrush="#FFD0D0D0"
                                Background="White"
                                CornerRadius="3"
                                MouseEnter="SnippetItem_MouseEnter"
                                MouseLeave="SnippetItem_MouseLeave"
                                MouseDown="SnippetItem_MouseDown"
                                ToolTipService.ShowDuration="60000">
                            <Border.ToolTip>
                                <ScrollViewer MinWidth="400" MinHeight="200" MaxHeight="600" MaxWidth="900" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                                    <TextBlock Text="{Binding XamlTemplate}" FontFamily="Consolas" FontSize="12" TextWrapping="Wrap"/>
                                </ScrollViewer>
                            </Border.ToolTip>
                            <Border.Effect>
                                <DropShadowEffect Color="Gray" 
                                                BlurRadius="5" 
                                                ShadowDepth="1" 
                                                Opacity="0.2"/>
                            </Border.Effect>
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <TextBlock Text="{Binding Name}" 
                                         FontWeight="SemiBold"/>
                                <TextBlock Grid.Row="1" 
                                         Text="{Binding Description}"
                                         TextWrapping="Wrap"
                                         Foreground="Gray"
                                         FontSize="12"
                                         Margin="0,3,0,0"/>
                                <!-- Live Preview -->
                                <ContentControl Grid.Row="2" Margin="0,6,0,0" Content="{Binding XamlTemplate, FallbackValue='[No preview available]'}" 
                                              ContentTemplate="{StaticResource SafeSnippetPreviewTemplate}"/>
                            </Grid>
                        </Border>
                        <DataTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="SnippetItem" Property="Background" Value="#FFF5F5F5"/>
                                <Setter TargetName="SnippetItem" Property="BorderBrush" Value="#FFA0A0A0"/>
                            </Trigger>
                        </DataTemplate.Triggers>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </Grid>
</UserControl>